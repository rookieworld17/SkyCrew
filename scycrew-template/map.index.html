<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <title>Drone Map Full System</title>

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #000;
    }
    #map {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

  const map = L.map('map').setView([51.0, 10.5], 7);

  // ─────────────────────────────────────────
  // ТЁМНАЯ КАРТА
  // ─────────────────────────────────────────
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap & CartoDB'
  }).addTo(map);

  // ─────────────────────────────────────────
  // WMS НАСТРОЙКИ
  // ─────────────────────────────────────────

  const wmsUrl = 'https://uas-betrieb.de/geoservices/dipul/ows?';

  const wmsLayersList =
    'flughaefen,flugplaetze,kontrollzonen,flugbeschraenkungsgebiete,' +
    'temporaere_betriebseinschraenkungen,inaktive_temporaere_betriebseinschraenkungen,' +
    'vogelschutzgebiete,naturschutzgebiete,ffh-gebiete,nationalparks,' +
    'wohngrundstuecke,behoerden,krankenhaeuser,militaerische_anlagen,justizvollzugsanstalten';

  const wmsLayer = L.tileLayer.wms(wmsUrl, {
    layers: wmsLayersList,
    format: 'image/png',
    transparent: true,
    version: '1.3.0',
    minZoom: 8 // WMS только при нормальном увеличении
  }).addTo(map);

  // ─────────────────────────────────────────
  // ОБРАБОТКА КЛИКА
  // ─────────────────────────────────────────

  map.on('click', async function(e) {

    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    const point = map.latLngToContainerPoint(e.latlng);
    const size = map.getSize();

    // ─────────────────────────────────────────
    // 1) Погода
    // ─────────────────────────────────────────

    const weatherUrl =
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&hourly=temperature_2m,wind_speed_10m&timezone=auto`;

    let weatherText = '';
    let windSpeed = 0;

    try {
      const weatherRes = await fetch(weatherUrl);
      const weather = await weatherRes.json();

      const temp = weather.hourly.temperature_2m[0];
      windSpeed = weather.hourly.wind_speed_10m[0];

      weatherText =
        `<b>Погода:</b><br>` +
        `Температура: ${temp}°C<br>` +
        `Ветер: ${windSpeed} м/с<br><br>`;

    } catch(err) {
      weatherText = 'Погода недоступна<br><br>';
    }


    // ─────────────────────────────────────────
    // 2) WMS GetFeatureInfo
    // ─────────────────────────────────────────

    const url =
      wmsUrl +
      'SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo' +
      '&LAYERS=' + wmsLayersList +
      '&QUERY_LAYERS=' + wmsLayersList +
      '&CRS=EPSG:4326' +
      `&BBOX=${map.getBounds().getSouth()},${map.getBounds().getWest()},${map.getBounds().getNorth()},${map.getBounds().getEast()}` +
      `&WIDTH=${size.x}&HEIGHT=${size.y}` +
      `&I=${Math.round(point.x)}&J=${Math.round(point.y)}` +
      '&INFO_FORMAT=application/json';

    let layerText = '';
    let zoneId = null;

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (data.features && data.features.length > 0) {
        const f = data.features[0];
        zoneId = f.id.toLowerCase();

        layerText =
          `<b>Зона:</b> ${f.id}<br>` +
          `<b>Геометрия:</b> ${f.geometry.type}<br><br>`;
      } else {
        layerText = 'Нет объектов в этой точке<br><br>';
      }

    } catch (err) {
      layerText = 'Ошибка WMS<br><br>';
    }

    // ─────────────────────────────────────────
    // 3) СЛОЖНОСТЬ ПОЛЁТА (формула из файла)
    // ─────────────────────────────────────────

    const E = 5;      // опыт пилота
    const Wmax = 12;  // максимально допустимый ветер

    // освещённость
    const hours = new Date().getHours();
    let N = 40;
    let D = 0;

    if (hours >= 21 || hours < 6) {
      N = 5;
      D = 1;
    } else if ((hours >= 18 && hours < 21) || (hours >= 6 && hours < 8)) {
      N = 20;
      D = 0.5;
    }

    const C =
      ((windSpeed / Wmax) * 40) +
      ((40 - N) * D) +
      ((12 - E) * 3);

    let difficulty = "";
    if (C < 40) difficulty = "Лёгкий полёт";
    else if (C < 80) difficulty = "Средняя сложность";
    else if (C < 120) difficulty = "Опасно";
    else difficulty = "ОЧЕНЬ ОПАСНО";

    const difficultyText =
      `<b>Сложность полёта:</b><br>` +
      `C = ${C.toFixed(1)}<br>` +
      `${difficulty}<br><br>`;


    // ─────────────────────────────────────────
    // 4) ЗАПРЕТЫ: зона + ветер
    // ─────────────────────────────────────────

    let noFlyWind = windSpeed > Wmax;
    let noFlyZone = false;
    let zoneReason = "";

    if (zoneId) {
      if (
        zoneId.includes("flughaefen") ||
        zoneId.includes("flugplaetze") ||
        zoneId.includes("militaerische_anlagen") ||
        zoneId.includes("behoerden") ||
        zoneId.includes("krankenhaeuser") ||     
        zoneId.includes("flugbeschraenkungsgebiete") ||
        zoneId.includes("krankenhaeuser") ||                           
        zoneId.includes("krankenhaeuser") ||        
        zoneId.includes("krankenhaeuser") ||        
        zoneId.includes("kontrollzonen")
      ) {
        noFlyZone = true;
        zoneReason = "контролируемое пространство / Полёт невозможен";
      }
    }

    let noFlyText = "<b>Запреты:</b><br>";

    if (!noFlyWind && !noFlyZone) {
      noFlyText += "нет<br><br>";
    } else {
      if (noFlyWind) noFlyText += "— слишком сильный ветер<br>";
      if (noFlyZone) noFlyText += `— ${zoneReason}<br>`;
      noFlyText += "<br>";
    }


    // ─────────────────────────────────────────
    // POPUP ВЫВОД
    // ─────────────────────────────────────────

    L.popup()
      .setLatLng(e.latlng)
      .setContent(
        `<b>Координаты:</b><br>` +
        `lat: ${lat.toFixed(6)}, lon: ${lon.toFixed(6)}<br><br>` +
        weatherText +
        noFlyText +
        difficultyText +
        layerText
      )
      .openOn(map);

  });

</script>

</body>
</html>
5